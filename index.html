<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Maki Host</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    body { margin:0; font-family:sans-serif; min-height:100vh; color:#e2e8f0; }
    .container { display:flex; min-height:100vh; }
    .sidebar { background:#101820; width:70px; min-width:70px; display:flex; flex-direction:column; align-items:center; padding-top:36px; box-shadow:2px 0 14px #00fff77a; gap:0.3em; z-index:10; }
    .logo { font-size:2em; font-weight:bold; color:#00fff7; margin-bottom:22px; letter-spacing:2px; text-shadow:0 2px 8px #00fff766; }
    .side-btn, .admin-btn { background:transparent; border:none; color:#00fff7; font-size:1.6em; margin:0.3em 0; border-radius:12px; transition:background 0.15s, color 0.2s; width:52px; height:52px; display:flex; align-items:center; justify-content:center; cursor:pointer; }
    .side-btn.active, .side-btn:hover, .admin-btn.active, .admin-btn:hover { background:#00fff71a; color:#fff; }
    .admin-btn { margin-top:1.5em; font-size:1.7em; display:none; }
    .main { flex:1; display:flex; flex-direction:column; align-items:stretch; min-height:100vh; padding:0 0.5em; margin-bottom:54px; }
    .topbar { display:flex; align-items:center; padding:0 28px; height:72px; background:rgba(56,189,248,0.09); box-shadow:0 4px 24px #00fff722; z-index:8; position:relative; }
    .topbar .title { font-size:1.4em; font-weight:600; color:#fff; letter-spacing:1px; margin-right:auto;}
    .topbar .logout-btn { background:#ff8800; color:#fff; border:none; border-radius:7px; padding:8px 16px; font-weight:bold; font-size:1em; margin-left:16px; cursor:pointer; box-shadow:0 2px 14px #ff88004a; transition:background 0.15s, color 0.2s;}
    .auth-panel { max-width:370px; margin:80px auto; background:#101820e8; box-shadow:0 2px 24px #00fff72a; border-radius:16px; padding:36px 32px; text-align:center; color:#e2e8f0;}
    .auth-panel h2 { margin-bottom:18px; color:#00fff7; font-weight:600; font-size:1.5em;}
    .auth-panel input { width:90%; padding:8px 12px; border:none; border-radius:7px; background:#1c232b; color:#00fff7; margin-bottom:14px; font-size:1.07em; outline:none; transition:box-shadow 0.15s;}
    .auth-panel input:focus { box-shadow:0 0 0 2px #00fff7;}
    .auth-panel button { background:#00fff7; color:#101820; border-radius:7px; border:none; font-weight:bold; font-size:1em; padding:9px 22px; margin-top:4px; cursor:pointer; margin-bottom:8px; box-shadow:0 2px 10px #00fff74a;}
    .auth-panel .secondary { background:#1c232b; color:#00fff7; border:1px solid #00fff7; margin-left:8px;}
    .auth-panel .extra { margin-top:16px; font-size:0.98em;}
    /* --- PANEL INTERNO --- */
    .panel-bg { background: #181818 !important; }
    .panel-main, .panel-card, .panel-modal-content { background: #222 !important; border-radius: 14px; box-shadow: none; color: #fff; border: none;}
    .panel-card { padding: 24px 20px 18px 20px; margin-bottom:24px; }
    .panel-btn, .admin-close-btn, .modal-close-btn, .card-btn, .console-send-btn { background:#ff8800 !important; color:#fff !important; border:none !important; border-radius:7px; font-weight:bold; font-size:1em; cursor:pointer; box-shadow:0 2px 10px #ff88004a; transition:background 0.15s, color 0.2s;}
    .panel-btn:disabled, .card-btn:disabled { background:#444 !important; color:#bbb !important; }
    .panel-input, .panel-select { background:#181818; color:#fff; border:1px solid #ff8800; border-radius:7px; padding:8px 12px; margin-bottom:8px;}
    .footer { width:100%; background:#181818 !important; color:#ff8800 !important; padding:18px 0 10px 0; text-align:center; font-size:1.05em; position:fixed; left:0; bottom:0; z-index:99; letter-spacing:1px;}
    /* Dashboard, tienda, etc */
    .card-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(270px,1fr)); gap:24px; margin:36px 30px 0 30px;}
    .card, .admin-panel, .modal-content { background:#222; border-radius:16px; box-shadow:none; color:#fff; display:flex; flex-direction:column; min-height:120px; position:relative; padding:28px 22px 22px 22px; border:none;}
    .card h3 { margin-top:0; margin-bottom:10px; color:#ff8800; font-size:1.15em; font-weight:600;}
    .card .coin-value { font-size:2.3em; font-weight:bold; color:#ff8800; margin-top:10px;}
    /* Modal, admin, menu */
    .admin-modal-bg, .modal-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:#181818cc; z-index:999; display:flex; align-items:center; justify-content:center;}
    .admin-panel, .modal-content { min-width:320px; max-width:450px; position:relative; box-shadow:none; padding:36px 32px; border:none;}
    .admin-panel h2, .modal-content h2 { margin-top:0; margin-bottom:22px; color:#ff8800; font-size:1.14em; font-weight:bold; text-align:center;}
    /* Men√∫ hamburguesa usuario */
    .hamburger { position:absolute; top:14px; left:20px; font-size:2em; color:#ff8800; background:none; border:none; cursor:pointer; z-index:99;}
    .user-menu { position:fixed; top:0; left:0; width:210px; height:100vh; background:#181818f0; box-shadow:none; padding-top:70px; z-index:1001; display:none; flex-direction:column; }
    .user-menu button { background:none; border:none; color:#ff8800; font-size:1.15em; text-align:left; padding:16px 24px; cursor:pointer; width:100%; transition:background 0.15s, color 0.2s;}
    .user-menu button:hover { background:#ff88001a; color:#fff;}
    .user-menu .close-menu { font-size:1.4em; position:absolute; top:12px; right:16px; background:none; border:none; color:#ff8800; cursor:pointer;}
    /* --- TERMINAL --- */
    .console-area { background:#181818; color:#39ff14; border-radius:8px; padding:12px; font-size:1.05em; height:180px; overflow-y:auto; font-family:monospace; border:1px solid #222;}
    .console-area .cmd-error { color: #ff4444; }
    .console-area .cmd-info { color: #ffe100; }
    .console-area .cmd-success { color: #39ff14; }
    .console-input-row { display:flex; gap:8px;}
    .console-input { flex:1; background:#181818; color:#fff; border:1px solid #ff8800; border-radius:5px; padding:4px; font-family:monospace;}
    .console-send-btn { background:#ff8800 !important; }
    /* Tabs servidor */
    .server-tabs {display:flex; gap:8px; margin-bottom:18px;}
    .server-tab-btn {background:#222; color:#ff8800; border:none; border-radius:5px; font-weight:bold; font-size:1em; cursor:pointer; padding:8px 16px;}
    .server-tab-btn.active, .server-tab-btn:hover {background:#ff88001a; color:#fff;}
    /* Responsive */
    @media (max-width:650px){ .card-grid{grid-template-columns:1fr;} .sidebar{width:56px;min-width:56px;} .sidebar .logo{font-size:1.2em;} .main{margin-bottom:54px;} .topbar{height:54px;} .topbar .title{font-size:1.1em;} }
  </style>
</head>
<body>
<div id="authPanels"></div>
<div class="container panel-bg" id="container" style="display:none">
  <div class="sidebar" id="sidebar">
    <div class="logo">Maki</div>
    <button class="side-btn" id="btn-dashboard" title="Dashboard"><i class="ri-dashboard-3-line"></i></button>
    <button class="admin-btn" id="btn-admin" title="Panel De administraci√≥n" onclick="showAdminCodeModal()"><i class="ri-shield-user-line"></i></button>
  </div>
  <div class="main panel-main">
    <div class="topbar">
      <span class="title" id="topbar-title">Dash Maki Host</span>
      <button class="logout-btn panel-btn" onclick="logout()">Salir</button>
    </div>
    <button class="hamburger" onclick="openUserMenu()" id="hamburgerBtn"><i class="ri-menu-line"></i></button>
    <div id="userMenu" class="user-menu"></div>
    <div id="dashboardPanel" class="card-grid"></div>
    <div id="serversPanel" class="card-grid" style="display:none"></div>
    <div id="ticketsPanel" class="card-grid" style="display:none"></div>
    <div id="storePanel" class="card-grid" style="display:none"></div>
    <div id="adminModal" class="admin-modal-bg" style="display:none">
      <div class="admin-panel panel-modal-content">
        <h2>Panel de Administraci√≥n</h2>
        <div id="adminUsers"></div>
        <button onclick="showAnnouncementModal()" style="margin-bottom: 14px;" class="panel-btn">üõ†Ô∏è Crear anuncio</button>
        <button onclick="closeAdminModal()" class="admin-close-btn panel-btn">Cerrar</button>
      </div>
    </div>
    <div id="adminCodeModal" class="modal-bg" style="display:none">
      <div class="modal-content panel-modal-content">
        <h2>Ingresa el c√≥digo de administrador</h2>
        <input id="adminCodeInput" placeholder="C√≥digo" autocomplete="off" class="panel-input"/>
        <div id="adminCodeMsg" style="color:#ff8800; margin-top:12px;"></div>
        <button onclick="checkAdminCode()" class="panel-btn">Entrar</button>
        <button onclick="closeAdminCodeModal()" class="modal-close-btn panel-btn">Cancelar</button>
      </div>
    </div>
    <div id="announcementModal" class="modal-bg" style="display:none;">
      <div class="modal-content panel-modal-content">
        <h2>üõ†Ô∏è Crear anuncio</h2>
        <textarea id="announcementInput" rows="3" style="margin-bottom:10px;resize:none;" placeholder="Escribe el anuncio aqu√≠" class="panel-input"></textarea>
        <button onclick="saveAnnouncement()" class="panel-btn">Guardar anuncio</button>
        <button onclick="closeAnnouncementModal()" class="modal-close-btn panel-btn">Cancelar</button>
      </div>
    </div>
    <div id="editUserModal" class="modal-bg" style="display:none;">
      <div class="modal-content panel-modal-content">
        <h2>Editar usuario</h2>
        <div id="editUserForm"></div>
        <button onclick="saveEditedUser()" class="panel-btn">Guardar cambios</button>
        <button onclick="closeEditUserModal()" class="modal-close-btn panel-btn">Cancelar</button>
      </div>
    </div>
  </div>
</div>
<div class="footer">¬© Maki Host | Todos los derechos reservados</div>
<script>
const STORAGE_KEY = "panel_sim_host_v2";
function getInitialData() {
  return {
    users: [
      { user:"admin", pass:"admin", correo:"admin@host.com", role:"admin", coinsUsed:0, coinsTotal:1000, servidores:[], bases:[], maxServers:3 },
      { user:"editor", pass:"editor", correo:"editor@host.com", role:"editor", coinsUsed:0, coinsTotal:300, servidores:[], bases:[], maxServers:2 },
    ],
    announcement: "",
  };
}
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(panelData)); }
function loadData() {
  let d = localStorage.getItem(STORAGE_KEY);
  if (d) return JSON.parse(d);
  return getInitialData();
}
let panelData = loadData();
let currentUser = null;
let editUserIdx = null;

const panels = ["dashboardPanel","serversPanel","ticketsPanel","storePanel"];
function showPanel(idx) {
  panels.forEach((id,i)=>{
    document.getElementById(id).style.display = (i===idx)?"grid":"none";
  });
  renderAll();
}

document.getElementById("btn-dashboard").onclick = ()=>showPanel(0);

function renderAuthPanels() {
  let html = '';
  html += `<div class="auth-panel" id="loginPanel">
    <h2>Iniciar Sesi√≥n</h2>
    <input id="loginUser" placeholder="Usuario" autocomplete="username" />
    <input id="loginPass" placeholder="Contrase√±a" type="password" autocomplete="current-password" />
    <button onclick="login()">Entrar</button>
    <div id="loginMsg"></div>
    <div class="extra">¬øNo tienes cuenta?
      <button onclick="showRegister()" class="secondary">Crear cuenta nueva</button>
    </div>
  </div>
  <div class="auth-panel" id="registerPanel" style="display:none">
    <h2>Crear Cuenta Nueva</h2>
    <input id="regUser" placeholder="Usuario" autocomplete="username" />
    <input id="regPass" placeholder="Contrase√±a" type="password" autocomplete="new-password" />
    <input id="regCorreo" placeholder="Correo" autocomplete="email" />
    <button onclick="register()">Registrar</button>
    <button onclick="showLogin()" class="secondary">Volver</button>
    <div id="regMsg"></div>
  </div>`;
  document.getElementById("authPanels").innerHTML = html;
}
function showLogin() {
  document.getElementById("loginPanel").style.display = "block";
  document.getElementById("registerPanel").style.display = "none";
  document.getElementById("loginMsg").textContent = "";
}
function showRegister() {
  document.getElementById("loginPanel").style.display = "none";
  document.getElementById("registerPanel").style.display = "block";
  document.getElementById("regMsg").textContent = "";
}
function register() {
  const regUser = document.getElementById("regUser").value.trim();
  const regPass = document.getElementById("regPass").value.trim();
  const regCorreo = document.getElementById("regCorreo").value.trim();
  if (!regUser || !regPass || !regCorreo) {
    document.getElementById("regMsg").textContent = "Todos los campos son obligatorios.";
    return;
  }
  if (panelData.users.find(u => u.user === regUser)) {
    document.getElementById("regMsg").textContent = "Ese usuario ya existe.";
    return;
  }
  const newUser = {
    user: regUser, pass: regPass, correo: regCorreo, role: "lector",
    coinsUsed:0, coinsTotal:0, servidores:[], bases:[], maxServers:1
  };
  panelData.users.push(newUser);
  saveData();
  document.getElementById("regMsg").textContent = "Cuenta creada, ahora puedes iniciar sesi√≥n.";
  setTimeout(() => { showLogin(); document.getElementById("loginUser").value = regUser; }, 1000);
}
function login() {
  const u = document.getElementById("loginUser").value;
  const p = document.getElementById("loginPass").value;
  const found = panelData.users.find(x => x.user === u && x.pass === p);
  if (found) {
    currentUser = found;
    document.getElementById("authPanels").style.display = "none";
    document.getElementById("container").style.display = "flex";
    showPanel(0);
    updateSidebarState();
  } else {
    document.getElementById("loginMsg").textContent = "Usuario o contrase√±a incorrectos";
  }
}
function logout() {
  currentUser = null;
  document.getElementById("authPanels").style.display = "block";
  document.getElementById("container").style.display = "none";
  renderAuthPanels();
  showLogin();
}

function renderAll() {
  renderDashboard();
  renderServers();
  renderTickets();
  renderStore();
  updateSidebarState();
  renderUserMenu();
}
function updateSidebarState() {
  document.getElementById("btn-admin").style.display = "block";
}

function openUserMenu() {
  renderUserMenu();
  document.getElementById("userMenu").style.display = "flex";
}
function closeUserMenu() {
  document.getElementById("userMenu").style.display = "none";
}
function renderUserMenu() {
  let html = `<button onclick="closeUserMenu()" class="close-menu"><i class="ri-close-line"></i></button>
    <button onclick="showPanel(0);closeUserMenu();">Principal</button>
    <button onclick="showPanel(1);closeUserMenu();">Servidores</button>
    <button onclick="showPanel(2);closeUserMenu();">Tickets</button>
    <button onclick="showPanel(3);closeUserMenu();">Tienda</button>`;
  document.getElementById("userMenu").innerHTML = html;
}

function renderDashboard() {
  let anuncio = panelData.announcement ? `<div style="background:#222;color:#ff8800;border-radius:7px;padding:8px 12px;font-weight:bold;margin-bottom:10px;">
    üõ†Ô∏èAnuncio de admins<br>${panelData.announcement}</div>` : "";
  document.getElementById("dashboardPanel").innerHTML = `
    <div class="card panel-card" style="">
      ${anuncio}
      <h3><i class="ri-coins-line"></i> Coins en uso</h3>
      <div class="coin-value" id="coinsUsed">${currentUser?.coinsUsed?.toFixed(2) ?? "0,00"}</div>
    </div>
    <div class="card panel-card" style="">
      <h3><i class="ri-copper-coin-line"></i> Coins totales</h3>
      <div class="coin-value" id="coinsTotal">${currentUser?.coinsTotal?.toFixed(2) ?? "0,00"}</div>
    </div>
    <div class="card panel-card" style="grid-column:span 2;">
      <h3><i class="ri-user-line"></i> Informaci√≥n de usuario</h3>
      <b>Usuario:</b> ${currentUser.user}<br>
      <b>Correo:</b> ${currentUser.correo}<br>
      <b>Rol:</b> ${currentUser.role}<br>
      <b>Servidores permitidos:</b> ${currentUser.maxServers ?? 1}
    </div>
  `;
}

function renderServers() {
  let html = `<div class="card panel-card">
    <h3><i class="ri-server-line"></i> Servidores</h3>`;
  if (!currentUser.servidores.length) html += `<div style="margin-bottom:8px;">No tienes servidores.</div>`;
  currentUser.servidores.forEach((srv,i)=>{
    html += `<div style="background:#222;color:#ff8800;border-radius:7px;padding:8px 12px;margin-bottom:6px;">
      <b>${srv.nombre}</b> (${srv.coins} coins) <button class="panel-btn" onclick="openServerModal(${i})">Abrir</button>
    </div>`;
  });
  let allowCreate = (currentUser.servidores.length < (currentUser.maxServers || 1));
  html += `<button class="card-btn panel-btn" onclick="createServer()" ${allowCreate?"":"disabled"}>+ Crear servidor</button>
    ${!allowCreate?'<div style="color:#ff4444;margin-top:8px;">Has alcanzado el l√≠mite de servidores permitidos.</div>':''}
    </div>`;
  document.getElementById("serversPanel").innerHTML = html;
}

// Modal servidor (console, files, startup, settings)
function openServerModal(idx) {
  let srv = currentUser.servidores[idx];
  let html = `
    <button onclick="closeServerModal()" class="close-menu" style="position:absolute;top:16px;right:20px;">‚úñ</button>
    <div class="server-tabs">
      <button onclick="showServerTab('consola')" id="tabConsola" class="server-tab-btn">Console</button>
      <button onclick="showServerTab('files')" id="tabFiles" class="server-tab-btn">Files</button>
      <button onclick="showServerTab('startup')" id="tabStartup" class="server-tab-btn">Startup</button>
      <button onclick="showServerTab('settings')" id="tabSettings" class="server-tab-btn">Settings</button>
    </div>
    <div id="serverTabContent"></div>
  `;
  showModal(html, "Servidor: " + srv.nombre);
  showServerTab('consola', srv);
  window.currentServerIdx = idx;
}
function showServerTab(tab, srv) {
  let idx = window.currentServerIdx;
  srv = srv || currentUser.servidores[idx];
  let html = "";
  // Reset active
  ["tabConsola","tabFiles","tabStartup","tabSettings"].forEach(el=>{
    let btn = document.getElementById(el);
    if(btn) btn.classList.remove("active");
  });
  let activeBtn = document.getElementById("tab"+tab.charAt(0).toUpperCase()+tab.slice(1));
  if(activeBtn) activeBtn.classList.add("active");
  if (tab==="consola") {
    html = `<div class="console-area" id="consoleOutput">${srv.consola||""}</div>
            <div class="console-input-row">
              <input class="console-input" id="consoleCmdInput" placeholder="Comando..." autocomplete="off">
              <button class="console-send-btn panel-btn" onclick="sendServerCmd(${idx})">Enviar</button>
            </div>`;
  } else if (tab==="files") {
    html = `<div><b>Archivos:</b></div>
      <ul class="list-ul" id="serverFileList">${(srv.files||[]).map(f=>`<li>${f}</li>`).join("")}</ul>
      <input id="newServerFile" class="panel-input" placeholder="Subir archivo (nombre)" />
      <button onclick="addServerFile(${idx})" class="card-btn panel-btn">Subir</button>`;
  } else if (tab==="startup") {
    html = `<div><b>Startup (repositorio GitHub):</b></div>
      <input id="startupRepo" class="panel-input" placeholder="URL o nombre del repo" value="${srv.startupRepo||""}">
      <button onclick="saveStartupRepo(${idx})" class="card-btn panel-btn">Guardar</button>
      <div style="margin-top:10px;color:#ff8800;">Ejemplo: user/repo o https://github.com/user/repo</div>`;
  } else if (tab==="settings") {
    html = `<div>
      <label>Nombre del servidor:</label>
      <input id="editSrvName" class="panel-input" value="${srv.nombre}" />
      <button onclick="saveSrvName(${idx})" class="panel-btn">Guardar</button>
      <button onclick="deleteServer(${idx})" class="panel-btn" style="background:#ff4444;">Eliminar servidor</button>
    </div>`;
  }
  document.getElementById("serverTabContent").innerHTML = html;
}
function closeServerModal() { closeModal(); }
function sendServerCmd(idx) {
  let cmd = document.getElementById("consoleCmdInput").value;
  if (!cmd) return;
  let srv = currentUser.servidores[idx];
  let out = srv.consola||"";
  out += `\n$ <span class="cmd-info">${cmd}</span>`;
  if (cmd.includes("git clone") || cmd.includes("startup") || cmd.includes("npm install")) {
    out += '\n<span class="cmd-info">Instalando repositorio...</span>';
    // Simula instalaci√≥n animada y error al final
    animateConsole(idx, out, [
      "Descargando archivos...",
      "Instalando dependencias...",
      "Compilando...",
      "Preparando entorno...",
      "ERROR: Dependencias incompatibles. Instalaci√≥n fallida."
    ]);
  } else if (cmd.includes("run bot")) {
    out += '\n<span class="cmd-success">Bot de WhatsApp iniciado!</span>';
    srv.consola = out;
    saveData();
    showServerTab('consola', srv);
    scrollConsole();
  } else {
    out += '\n<span class="cmd-success">Comando ejecutado: ' + cmd + '</span>';
    srv.consola = out;
    saveData();
    showServerTab('consola', srv);
    scrollConsole();
  }
  document.getElementById("consoleCmdInput").value = "";
}
function animateConsole(idx, baseOut, steps, i=0) {
  let srv = currentUser.servidores[idx];
  if(i < steps.length) {
    srv.consola = baseOut + steps.slice(0,i+1).map((step,j)=>{
      if(j===steps.length-1) return `<span class="cmd-error">${step}</span>`;
      return `<span class="cmd-info">${step}</span>`;
    }).join("\n");
    saveData();
    showServerTab('consola', srv);
    scrollConsole();
    setTimeout(()=>animateConsole(idx,baseOut,steps,i+1), 900);
  }
}
function scrollConsole() {
  let out = document.getElementById("consoleOutput");
  if(out) out.scrollTop = out.scrollHeight;
}
function addServerFile(idx) {
  let f = document.getElementById("newServerFile").value.trim();
  if (!f) return;
  let srv = currentUser.servidores[idx];
  if (!srv.files) srv.files = [];
  srv.files.push(f);
  saveData();
  showServerTab('files', srv);
  document.getElementById("newServerFile").value = "";
}
function saveStartupRepo(idx) {
  let repo = document.getElementById("startupRepo").value.trim();
  let srv = currentUser.servidores[idx];
  srv.startupRepo = repo;
  saveData();
  showServerTab('startup', srv);
}
function saveSrvName(idx) {
  let name = document.getElementById("editSrvName").value.trim();
  if(!name) return;
  let srv = currentUser.servidores[idx];
  srv.nombre = name;
  saveData();
  showServerTab('settings', srv);
}
function deleteServer(idx) {
  if(confirm("¬øSeguro que quieres eliminar este servidor?")) {
    currentUser.servidores.splice(idx,1);
    saveData();
    closeServerModal();
    renderServers();
  }
}

function createServer() {
  let allowCreate = (currentUser.servidores.length < (currentUser.maxServers || 1));
  if (!allowCreate) {
    alert("Has alcanzado el l√≠mite de servidores permitidos.");
    return;
  }
  if (currentUser.coinsTotal < 100) {
    alert("Necesitas al menos 100 coins para crear un servidor.");
    return;
  }
  let nombre = prompt("Nombre del servidor:");
  if (!nombre) return;
  currentUser.servidores.push({nombre,coins:100,consola:"",files:[],startupRepo:""});
  saveData();
  renderServers();
}

function renderTickets() {
  document.getElementById("ticketsPanel").innerHTML = `<div class="card panel-card">
    <h3><i class="ri-question-line"></i> Tickets</h3>
    <div>No hay tickets a√∫n.</div>
  </div>`;
}

function renderStore() {
  let html = `<div class="card panel-card">
    <h3><i class="ri-shopping-cart-line"></i> Tienda</h3>
    <b>Plan 1: 200 coins</b> <button class="panel-btn" onclick="buyPlan(200,'MAK28')">Comprar</button><br>
    <b>Plan 2: 400 coins</b> <button class="panel-btn" onclick="buyPlan(400,'MAK29')">Comprar</button><br>
    <b>Plan 3: 200 coins</b> <button class="panel-btn" onclick="buyPlan(200,'MAK30')">Comprar</button><br>
    <b>Plan 4: 400 coins</b> <button class="panel-btn" onclick="buyPlan(400,'MAK21')">Comprar</button><br>
    <div id="storeMsg" style="color:#ff8800;margin-top:10px;"></div>
  </div>`;
  document.getElementById("storePanel").innerHTML = html;
}
function buyPlan(coins, token) {
  let t = prompt("Introduce el token de compra:");
  if (!["MAK28","MAK29","MAK30","MAK21"].includes(t)) {
    document.getElementById("storeMsg").textContent = "Token incorrecto.";
    return;
  }
  currentUser.coinsTotal += coins;
  saveData();
  document.getElementById("storeMsg").textContent = "¬°Compra exitosa! Coins a√±adidos.";
  renderDashboard();
}

function showAdminCodeModal() {
  document.getElementById("adminCodeModal").style.display = "flex";
  document.getElementById("adminCodeInput").value = "";
  document.getElementById("adminCodeMsg").textContent = "";
}
function closeAdminCodeModal() {
  document.getElementById("adminCodeModal").style.display = "none";
}
function checkAdminCode() {
  let c = document.getElementById("adminCodeInput").value.trim();
  if (c !== "MAK1") {
    document.getElementById("adminCodeMsg").textContent = "C√≥digo incorrecto.";
    return;
  }
  document.getElementById("adminCodeModal").style.display = "none";
  showAdminPanel();
}
function showAdminPanel() {
  document.getElementById("adminModal").style.display = "flex";
  renderAdminUsers();
}
function closeAdminModal() {
  document.getElementById("adminModal").style.display = "none";
}
function renderAdminUsers() {
  let container = document.getElementById("adminUsers");
  container.innerHTML = "";
  panelData.users.forEach((u, idx) => {
    const row = document.createElement("div");
    row.className = "admin-user-row";
    const correo = document.createElement("span");
    correo.className = "admin-user-label";
    correo.textContent = u.correo;
    row.appendChild(correo);
    const editBtn = document.createElement("button");
    editBtn.innerHTML = '<i class="ri-pencil-line"></i>';
    editBtn.onclick = ()=>openEditUserModal(idx);
    row.appendChild(editBtn);
    container.appendChild(row);
  });
}
function openEditUserModal(idx) {
  editUserIdx = idx;
  let u = panelData.users[idx];
  let html = `
    <label>Correo: <input id="editCorreo" class="panel-input" value="${u.correo}" /></label><br>
    <label>Coins usados: <input type="number" id="editCoinsUsed" class="panel-input" value="${u.coinsUsed}" /></label><br>
    <label>Coins totales: <input type="number" id="editCoinsTotal" class="panel-input" value="${u.coinsTotal}" /></label><br>
    <label>Servidores permitidos: <input type="number" id="editMaxServers" class="panel-input" value="${u.maxServers??1}" min="1" /></label><br>
    <label>Servidores: <input id="editServidores" class="panel-input" value="${u.servidores.map(s=>s.nombre).join(',')}" placeholder="nombres separados por coma" /></label><br>
    <label>Bases de datos: <input id="editBases" class="panel-input" value="${u.bases.join(',')}" placeholder="bases separadas por coma" /></label>
  `;
  document.getElementById("editUserForm").innerHTML = html;
  document.getElementById("editUserModal").style.display = "flex";
}
function closeEditUserModal() {
  document.getElementById("editUserModal").style.display = "none";
}
function saveEditedUser() {
  let u = panelData.users[editUserIdx];
  u.correo = document.getElementById("editCorreo").value;
  u.coinsUsed = parseFloat(document.getElementById("editCoinsUsed").value)||0;
  u.coinsTotal = parseFloat(document.getElementById("editCoinsTotal").value)||0;
  u.maxServers = parseInt(document.getElementById("editMaxServers").value)||1;
  let servers = document.getElementById("editServidores").value.split(',').map(s=>s.trim()).filter(Boolean);
  u.servidores = servers.map(s=>({nombre:s,coins:100,consola:"",files:[],startupRepo:""}));
  u.bases = document.getElementById("editBases").value.split(',').map(b=>b.trim()).filter(Boolean);
  saveData();
  renderAdminUsers();
  closeEditUserModal();
  if (currentUser && u.user === currentUser.user) {
    currentUser = u;
    renderAll();
  }
}

function showAnnouncementModal() {
  document.getElementById("announcementInput").value = panelData.announcement;
  document.getElementById("announcementModal").style.display = "flex";
}
function closeAnnouncementModal() {
  document.getElementById("announcementModal").style.display = "none";
}
function saveAnnouncement() {
  panelData.announcement = document.getElementById("announcementInput").value;
  saveData();
  renderDashboard();
  closeAnnouncementModal();
}

function showModal(html, titulo) {
  let div = document.createElement("div");
  div.className = "modal-bg";
  div.innerHTML = `<div class="modal-content panel-modal-content"><h2>${titulo||""}</h2>${html}</div>`;
  document.body.appendChild(div);
  window.currentModal = div;
}
function closeModal() {
  if (window.currentModal) document.body.removeChild(window.currentModal);
  window.currentModal = null;
}

function now() { return new Date().toLocaleString(); }

renderAuthPanels();
showLogin();
</script>
</body>
</html>