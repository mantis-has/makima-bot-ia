<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Panel Hosting</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet">
  <style>
    /* ... (todo el CSS igual que antes, lo puedes copiar de tu versión previa) ... */
  </style>
</head>
<body>
<div id="authPanels"></div>
<div class="container panel-bg" id="container" style="display:none">
  <div class="sidebar" id="sidebar">
    <div class="logo">Maki</div>
    <button class="side-btn" id="btn-dashboard" title="Dashboard"><i class="ri-dashboard-3-line"></i></button>
    <button class="admin-btn" id="btn-admin" title="Panel Administrativo" onclick="showAdminCodeModal()"><i class="ri-shield-user-line"></i></button>
  </div>
  <div class="main panel-main">
    <div class="topbar">
      <span class="title" id="topbar-title">Panel de Usuario</span>
      <button class="logout-btn panel-btn" onclick="logout()">Salir</button>
    </div>
    <button class="hamburger" onclick="openUserMenu()" id="hamburgerBtn"><i class="ri-menu-line"></i></button>
    <div id="userMenu" class="user-menu"></div>
    <div id="dashboardPanel" class="card-grid"></div>
    <div id="serversPanel" class="card-grid" style="display:none"></div>
    <div id="ticketsPanel" class="card-grid" style="display:none"></div>
    <div id="storePanel" class="card-grid" style="display:none"></div>
    <div id="adminModal" class="admin-modal-bg" style="display:none">
      <div class="admin-panel panel-modal-content">
        <h2>Panel de Administración</h2>
        <div id="adminUsers"></div>
        <button onclick="closeAdminModal()" class="admin-close-btn panel-btn">Cerrar</button>
      </div>
    </div>
    <div id="adminCodeModal" class="modal-bg" style="display:none">
      <div class="modal-content panel-modal-content">
        <h2>Ingresa el código de administrador</h2>
        <input id="adminCodeInput" placeholder="Código" autocomplete="off" class="panel-input"/>
        <div id="adminCodeMsg" style="color:#ff8800; margin-top:12px;"></div>
        <button onclick="checkAdminCode()" class="panel-btn">Entrar</button>
        <button onclick="closeAdminCodeModal()" class="modal-close-btn panel-btn">Cancelar</button>
      </div>
    </div>
    <div id="editUserModal" class="modal-bg" style="display:none;">
      <div class="modal-content panel-modal-content">
        <h2>Editar usuario</h2>
        <div id="editUserForm"></div>
        <button onclick="saveEditedUser()" class="panel-btn">Guardar cambios</button>
        <button onclick="closeEditUserModal()" class="modal-close-btn panel-btn">Cancelar</button>
      </div>
    </div>
  </div>
</div>
<div class="footer">© Panel Hosting Simulado | Todos los derechos reservados</div>
<script>
const STORAGE_KEY = "panel_sim_host_v2";
function getInitialData() {
  return {
    users: [
      { usuario:"admin", correo:"admin@host.com", pass:"admin", token:"admin-token", role:"admin", coinsUsed:0, coinsTotal:1000, servidores:[], bases:[], maxServers:3 },
      { usuario:"editor", correo:"editor@host.com", pass:"editor", token:"editor-token", role:"lector", coinsUsed:0, coinsTotal:300, servidores:[], bases:[], maxServers:2 }
    ]
  };
}
function saveData() { localStorage.setItem(STORAGE_KEY, JSON.stringify(panelData)); }
function loadData() {
  let d = localStorage.getItem(STORAGE_KEY);
  if (d) return JSON.parse(d);
  return getInitialData();
}
let panelData = loadData();
let currentUser = null;
let editUserIdx = null;
const panels = ["dashboardPanel","serversPanel","ticketsPanel","storePanel"];
function showPanel(idx) {
  panels.forEach((id,i)=>{
    document.getElementById(id).style.display = (i===idx)?"grid":"none";
  });
  renderAll();
}
document.getElementById("btn-dashboard").onclick = ()=>showPanel(0);
function renderAuthPanels() {
  let html = `
    <div class="auth-panel" id="loginPanel">
      <h2>Iniciar Sesión</h2>
      <input id="loginUser" placeholder="Usuario" autocomplete="username" />
      <input id="loginPass" placeholder="Contraseña" type="password" autocomplete="current-password" />
      <input id="loginToken" placeholder="Token" autocomplete="off" />
      <button onclick="login()">Entrar</button>
      <div id="loginMsg"></div>
      <div class="extra">¿No tienes cuenta?
        <button onclick="showRegister()" class="secondary">Crear cuenta nueva</button>
      </div>
    </div>
    <div class="auth-panel" id="registerPanel" style="display:none">
      <h2>Crear Cuenta Nueva</h2>
      <input id="regUser" placeholder="Usuario" autocomplete="username" />
      <input id="regCorreo" placeholder="Correo" autocomplete="email" />
      <input id="regPass" placeholder="Contraseña" type="password" autocomplete="new-password" />
      <input id="regToken" placeholder="Token privado" autocomplete="off" />
      <button onclick="register()">Registrar</button>
      <button onclick="showLogin()" class="secondary">Volver</button>
      <div id="regMsg"></div>
    </div>`;
  document.getElementById("authPanels").innerHTML = html;
}
function showLogin() {
  document.getElementById("loginPanel").style.display = "block";
  document.getElementById("registerPanel").style.display = "none";
  document.getElementById("loginMsg").textContent = "";
}
function showRegister() {
  document.getElementById("loginPanel").style.display = "none";
  document.getElementById("registerPanel").style.display = "block";
  document.getElementById("regMsg").textContent = "";
}
function register() {
  const usuario = document.getElementById("regUser").value.trim();
  const correo = document.getElementById("regCorreo").value.trim();
  const pass = document.getElementById("regPass").value.trim();
  const token = document.getElementById("regToken").value.trim();
  if (!usuario || !correo || !pass || !token) {
    document.getElementById("regMsg").textContent = "Todos los campos son obligatorios.";
    return;
  }
  if (panelData.users.find(u => u.usuario === usuario)) {
    document.getElementById("regMsg").textContent = "Ese usuario ya existe.";
    return;
  }
  const newUser = {
    usuario, correo, pass, token, role: "lector",
    coinsUsed:0, coinsTotal:0, servidores:[], bases:[], maxServers:1
  };
  panelData.users.push(newUser);
  saveData();
  // Login automático tras registrar
  currentUser = newUser;
  document.getElementById("authPanels").style.display = "none";
  document.getElementById("container").style.display = "flex";
  showPanel(0);
  updateSidebarState();
}
function login() {
  const usuario = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value.trim();
  const token = document.getElementById("loginToken").value.trim();
  const found = panelData.users.find(x => x.usuario === usuario && x.pass === pass && x.token === token);
  if (found) {
    currentUser = found;
    document.getElementById("authPanels").style.display = "none";
    document.getElementById("container").style.display = "flex";
    showPanel(0);
    updateSidebarState();
  } else {
    document.getElementById("loginMsg").textContent = "Usuario, contraseña o token incorrectos";
  }
}
function logout() {
  currentUser = null;
  document.getElementById("authPanels").style.display = "block";
  document.getElementById("container").style.display = "none";
  renderAuthPanels();
  showLogin();
}
function renderAll() {
  renderDashboard();
  renderServers();
  renderTickets();
  renderStore();
  updateSidebarState();
  renderUserMenu();
}
function updateSidebarState() {
  document.getElementById("btn-admin").style.display = (currentUser && currentUser.role === "admin") ? "block" : "none";
}
function openUserMenu() {
  let html = `<button onclick="closeUserMenu()" class="close-menu"><i class="ri-close-line"></i></button>
    <button onclick="showPanel(0);closeUserMenu();">Principal</button>
    <button onclick="showPanel(1);closeUserMenu();">Servidores</button>
    <button onclick="showPanel(2);closeUserMenu();">Tickets</button>
    <button onclick="showPanel(3);closeUserMenu();">Tienda</button>`;
  document.getElementById("userMenu").innerHTML = html;
  document.getElementById("userMenu").style.display = "flex";
}
function closeUserMenu() {
  document.getElementById("userMenu").style.display = "none";
}
function renderDashboard() {
  document.getElementById("dashboardPanel").innerHTML = `
    <div class="card panel-card">
      <h3><i class="ri-coins-line"></i> Coins en uso</h3>
      <div class="coin-value">${currentUser?.coinsUsed?.toFixed(2) ?? "0,00"}</div>
    </div>
    <div class="card panel-card">
      <h3><i class="ri-copper-coin-line"></i> Coins totales</h3>
      <div class="coin-value">${currentUser?.coinsTotal?.toFixed(2) ?? "0,00"}</div>
    </div>
    <div class="card panel-card" style="grid-column:span 2;">
      <h3><i class="ri-user-line"></i> Información de usuario</h3>
      <b>Usuario:</b> ${currentUser.usuario}<br>
      <b>Correo:</b> ${currentUser.correo}<br>
      <b>Rol:</b> ${currentUser.role}<br>
      <b>Servidores permitidos:</b> ${currentUser.maxServers ?? 1}
    </div>
  `;
}
function renderServers() {
  let html = `<div class="card panel-card">
    <h3><i class="ri-server-line"></i> Servidores</h3>`;
  if (!currentUser.servidores.length) html += `<div style="margin-bottom:8px;">No tienes servidores.</div>`;
  currentUser.servidores.forEach((srv,i)=>{
    html += `<div style="background:#222;color:#ff8800;border-radius:7px;padding:8px 12px;margin-bottom:6px;">
      <b>${srv.nombre}</b> (${srv.coins} coins)
    </div>`;
  });
  let allowCreate = (currentUser.servidores.length < (currentUser.maxServers || 1));
  html += `<button class="card-btn panel-btn" onclick="createServer()" ${allowCreate?"":"disabled"}>+ Crear servidor</button>
    ${!allowCreate?'<div style="color:#ff4444;margin-top:8px;">Has alcanzado el límite de servidores permitidos.</div>':''}
    </div>`;
  document.getElementById("serversPanel").innerHTML = html;
}
function createServer() {
  let allowCreate = (currentUser.servidores.length < (currentUser.maxServers || 1));
  if (!allowCreate) {
    alert("Has alcanzado el límite de servidores permitidos.");
    return;
  }
  if (currentUser.coinsTotal < 100) {
    alert("Necesitas al menos 100 coins para crear un servidor.");
    return;
  }
  let nombre = prompt("Nombre del servidor:");
  if (!nombre) return;
  currentUser.servidores.push({nombre,coins:100});
  saveData();
  renderServers();
}
function renderTickets() {
  document.getElementById("ticketsPanel").innerHTML = `<div class="card panel-card">
    <h3><i class="ri-question-line"></i> Tickets</h3>
    <div>No hay tickets aún.</div>
  </div>`;
}
function renderStore() {
  let html = `<div class="card panel-card">
    <h3><i class="ri-shopping-cart-line"></i> Tienda</h3>
    <b>Plan 1: 200 coins</b> <button class="panel-btn" onclick="buyPlan(200,'MAK28')">Comprar</button><br>
    <b>Plan 2: 400 coins</b> <button class="panel-btn" onclick="buyPlan(400,'MAK29')">Comprar</button><br>
    <div id="storeMsg" style="color:#ff8800;margin-top:10px;"></div>
  </div>`;
  document.getElementById("storePanel").innerHTML = html;
}
function buyPlan(coins, token) {
  let t = prompt("Introduce el token de compra:");
  if (!["MAK28","MAK29"].includes(t)) {
    document.getElementById("storeMsg").textContent = "Token incorrecto.";
    return;
  }
  currentUser.coinsTotal += coins;
  saveData();
  document.getElementById("storeMsg").textContent = "¡Compra exitosa! Coins añadidos.";
  renderDashboard();
}
function showAdminCodeModal() {
  document.getElementById("adminCodeModal").style.display = "flex";
  document.getElementById("adminCodeInput").value = "";
  document.getElementById("adminCodeMsg").textContent = "";
  renderAdminUsers();
}
function closeAdminCodeModal() {
  document.getElementById("adminCodeModal").style.display = "none";
}
function checkAdminCode() {
  let c = document.getElementById("adminCodeInput").value.trim();
  if (c !== "MAK1") {
    document.getElementById("adminCodeMsg").textContent = "Código incorrecto.";
    return;
  }
  document.getElementById("adminCodeModal").style.display = "none";
  showAdminPanel();
}
function showAdminPanel() {
  document.getElementById("adminModal").style.display = "flex";
  renderAdminUsers();
}
function closeAdminModal() {
  document.getElementById("adminModal").style.display = "none";
}
function renderAdminUsers() {
  let container = document.getElementById("adminUsers");
  container.innerHTML = "";
  panelData.users.forEach((u, idx) => {
    const row = document.createElement("div");
    row.className = "admin-user-row";
    const correo = document.createElement("span");
    correo.className = "admin-user-label";
    correo.textContent = u.correo + " (" + u.usuario + ")";
    row.appendChild(correo);
    const editBtn = document.createElement("button");
    editBtn.innerHTML = '<i class="ri-pencil-line"></i>';
    editBtn.onclick = ()=>openEditUserModal(idx);
    row.appendChild(editBtn);
    container.appendChild(row);
  });
}
function openEditUserModal(idx) {
  editUserIdx = idx;
  let u = panelData.users[idx];
  let html = `
    <label>Correo: <input id="editCorreo" class="panel-input" value="${u.correo}" /></label><br>
    <label>Usuario: <input id="editUsuario" class="panel-input" value="${u.usuario}" /></label><br>
    <label>Token: <input id="editToken" class="panel-input" value="${u.token}" /></label><br>
    <label>Rol: <select id="editRol" class="panel-select">
      <option value="lector" ${u.role=="lector"?"selected":""}>Lector</option>
      <option value="admin" ${u.role=="admin"?"selected":""}>Admin</option>
    </select></label><br>
    <label>Coins usados: <input type="number" id="editCoinsUsed" class="panel-input" value="${u.coinsUsed}" /></label><br>
    <label>Coins totales: <input type="number" id="editCoinsTotal" class="panel-input" value="${u.coinsTotal}" /></label><br>
    <label>Servidores permitidos: <input type="number" id="editMaxServers" class="panel-input" value="${u.maxServers??1}" min="1" /></label><br>
    <button onclick="saveEditedUser()" class="panel-btn">Guardar</button>
    <button onclick="closeEditUserModal()" class="modal-close-btn panel-btn">Cancelar</button>
  `;
  document.getElementById("editUserForm").innerHTML = html;
  document.getElementById("editUserModal").style.display = "flex";
}
function closeEditUserModal() {
  document.getElementById("editUserModal").style.display = "none";
}
function saveEditedUser() {
  let u = panelData.users[editUserIdx];
  u.correo = document.getElementById("editCorreo").value;
  u.usuario = document.getElementById("editUsuario").value;
  u.token = document.getElementById("editToken").value;
  u.role = document.getElementById("editRol").value;
  u.coinsUsed = parseFloat(document.getElementById("editCoinsUsed").value)||0;
  u.coinsTotal = parseFloat(document.getElementById("editCoinsTotal").value)||0;
  u.maxServers = parseInt(document.getElementById("editMaxServers").value)||1;
  saveData();
  renderAdminUsers();
  closeEditUserModal();
  if (currentUser && u.usuario === currentUser.usuario) {
    currentUser = u;
    renderAll();
  }
}
renderAuthPanels();
showLogin();
</script>
</body>
</html>